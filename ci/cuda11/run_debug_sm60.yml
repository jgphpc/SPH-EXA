include:
  - local: 'ci/common.yml'

#{{{ sph:pull:cuda11:sm60:debug:
sph:pull:cuda11:sm60:debug:
  needs: ['sph:build:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHpull
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    - echo "Pulling image=${BUILD_CUDA11_SM60_DEBUG}"
    - echo "  CSCS_REGISTRY_PATH=${CSCS_REGISTRY_PATH}"
    - echo "  PERSIST_IMAGE_NAME=${PERSIST_IMAGE_NAME}"
  variables:
    PULL_IMAGE: 'YES'
    # XDG_DATA_HOME=/dev/shm/$(id -u)
    # PERSIST_IMAGE_NAME: "${BUILD_CUDA11_SM60_DEBUG}"
#}}}

#{{{ sph:test:cuda11:sm60:debug:domain:n1:
sph:test:cuda11:sm60:debug:domain:n1:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    # - echo "SLURMD_NODENAME=${SLURMD_NODENAME} SLURM_NODEID=${SLURM_NODEID} SLURM_PROCID=${SLURM_PROCID}"
    - /usr/local/games/build/domain/test/coord_samples/coordinate_test
    - /usr/local/games/build/domain/test/performance/scan_perf
    - /usr/local/games/build/domain/test/unit/component_units
    - /usr/local/games/build/domain/test/unit/component_units_omp
    - /usr/local/games/build/domain/test/unit_cuda/component_units_cuda
    - /usr/local/games/build/domain/test/integration_mpi/domain_gpu
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 1
    SLURM_NTASKS_PER_NODE: 1
    PULL_IMAGE: 'NO'
    # SLURM_PARTITION
    # SLURM_TIMELIMIT    
#}}}
#{{{ sph:test:cuda11:sm60:debug:domain:n2N1:
sph:test:cuda11:sm60:debug:domain:n2N1:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    - echo "$MYTEST"
    - $MYTEST
  parallel:
    matrix:
      - MYTEST: ["/usr/local/games/build/domain/test/integration_mpi/globaloctree", "/usr/local/games/build/domain/test/integration_mpi/exchange_halos", "/usr/local/games/build/domain/test/integration_mpi/box_mpi", "/usr/local/games/build/domain/test/integration_mpi/exchange_focus", "/usr/local/games/build/domain/test/integration_mpi/exchange_keys", "/usr/local/games/build/domain/test/integration_mpi/focus_transfer", "/usr/local/games/build/domain/test/integration_mpi/domain_2ranks", "/usr/local/games/build/domain/test/integration_mpi/domain_resize"]
      # - MYSM: ["sm_60"]
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 2
    SLURM_NTASKS_PER_NODE: 2
    PULL_IMAGE: 'NO'
    SLURM_MPI_TYPE: 'pmi2'
    # SLURM_PARTITION
    # SLURM_TIMELIMIT    
#}}}
#{{{ sph:test:cuda11:sm60:debug:domain:n2N2:
sph:test:cuda11:sm60:debug:domain:n2N2:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    - echo "$MYTEST"
    - $MYTEST
  parallel:
    matrix:
      - MYTEST: ["/usr/local/games/build/domain/test/integration_mpi/exchange_halos_gpu", "/usr/local/games/build/domain/test/integration_mpi/exchange_domain_gpu", "/usr/local/games/build/domain/test/integration_mpi/assignment_gpu", "/usr/local/games/build/domain/test/integration_mpi/domain_gpu"]
      # - MYSM: ["sm_60"]
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 2
    SLURM_NTASKS: 2
    SLURM_NTASKS_PER_NODE: 1
    PULL_IMAGE: 'NO'
    SLURM_MPI_TYPE: 'pmi2'
    # SLURM_PARTITION
    # SLURM_TIMELIMIT    
#}}}
#{{{ sph:test:cuda11:sm60:debug:domain:n12N1:
sph:test:cuda11:sm60:debug:domain:n12N1:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    - echo "$MYTEST"
    - $MYTEST
  parallel:
    matrix:
      - MYTEST: ["/usr/local/games/build/domain/test/integration_mpi/treedomain", "/usr/local/games/build/domain/test/integration_mpi/exchange_general", "/usr/local/games/build/domain/test/integration_mpi/exchange_domain", "/usr/local/games/build/domain/test/integration_mpi/focus_tree", "/usr/local/games/build/domain/test/integration_mpi/domain_nranks"]
      # - MYSM: ["sm_60"]
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 12
    SLURM_NTASKS_PER_NODE: 12
    SLURM_MPI_TYPE: 'pmi2'
    PULL_IMAGE: 'NO'
    # SLURM_PARTITION
    # SLURM_TIMELIMIT    
#}}}

#{{{ sph:test:cuda11:sm60:debug:ryoanji:n1:
sph:test:cuda11:sm60:debug:ryoanji:n1:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    - /usr/local/games/build/ryoanji/test/ryoanji_cpu_unit_tests
    - /usr/local/games/build/ryoanji/test/ryoanji_unit_tests
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 1
    SLURM_NTASKS_PER_NODE: 1
    PULL_IMAGE: 'NO'
    # SLURM_PARTITION
    # SLURM_TIMELIMIT    
#}}}
#{{{ sph:test:cuda11:sm60:debug:ryoanji:n2N2:
sph:test:cuda11:sm60:debug:ryoanji:n2N2:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  # TODO: explain why sarus hangs with -n>2, it should be run with -n6 or -n10
  script:
    - echo "$MYTEST"
    - $MYTEST
  parallel:
    matrix:
      - MYTEST: ["/usr/local/games/build/ryoanji/test/interface/global_upsweep_cpu", "/usr/local/games/build/ryoanji/test/interface/global_upsweep_gpu", "/usr/local/games/build/ryoanji/test/interface/global_forces_gpu"]
      # - MYSM: ["sm_60"]
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 2
    SLURM_NTASKS: 2
    SLURM_NTASKS_PER_NODE: 1
    PULL_IMAGE: 'NO'
    SLURM_MPI_TYPE: 'pmi2'
    SLURM_PARTITION: 'normal'
    # SLURM_TIMELIMIT    
#}}}

#{{{ sph:test:cuda11:sm60:debug:sph:n1:
sph:test:cuda11:sm60:debug:sph:n1:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    - ln -s /usr/local/games/build/sph/test/example_data.txt .
    - /usr/local/games/build/sph/test/sph_tests
    - /usr/local/games/build/sph/test/hydro_turb/turbulence_tests
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 1
    SLURM_NTASKS_PER_NODE: 1
    PULL_IMAGE: 'NO'
    # SLURM_PARTITION
    # SLURM_TIMELIMIT    
#}}}

#{{{ sph:test:cuda11:sm60:debug:main:n1:
sph:test:cuda11:sm60:debug:main:n1:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    - /usr/local/games/build/main/test/frontend_units
    - /usr/local/games/build/main/test/frontend_units_cuda
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 1
    SLURM_NTASKS_PER_NODE: 1
    PULL_IMAGE: 'NO'
    # SLURM_PARTITION
    # SLURM_TIMELIMIT    
#}}}
#{{{ sph:test:cuda11:sm60:debug:main:n2N1:
sph:test:cuda11:sm60:debug:main:n2N1:
  needs: ['sph:pull:cuda11:sm60:debug']
  extends: .container-runner-daint-gpu
  stage: SPHtest
  image: ${BUILD_CUDA11_SM60_DEBUG}
  script:
    - /usr/local/games/build/main/test/mpi/hdf5io
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 2
    SLURM_NTASKS_PER_NODE: 1
    PULL_IMAGE: 'NO'
    SLURM_MPI_TYPE: 'pmi2'
    # SLURM_PARTITION
    # SLURM_TIMELIMIT    
#}}}
