# # https://gitlab.com/cscs-ci/ci-testing/webhook-ci/gitlab-runner-k8s-container-builder.git
include:
  - local: 'ci/common.yml'
#   - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'
# 
# stages:
#   - SPHbase     # no srun (extends=.container-builder-dynamic-name)
#   - SPHbuild    # no srun (extends=.container-builder)
#   - SPHpull     # on daint
#   - SPHtest     # on daint

#{{{ sph:base:cuda:
sph:base:cuda11:
  extends: .container-builder-dynamic-name
  stage: SPHbase
  variables:
    # tried with if/else, no success -> must comment/uncomment
    # ---
    # DOCKERFILE: '.gitlab/Dockerfile_1'
    # PERSIST_IMAGE_NAME: "${BASE_CUDA}"
    # ---
    # BASE_CUDA: "${CSCS_REGISTRY_PATH}/base/sph-exa_base-cuda11"
    DOCKERFILE: 'ci/cuda11/Dockerfile_1'
    WATCH_FILECHANGES: 'ci/cuda11/Dockerfile_1'
    PERSIST_IMAGE_NAME: "${CSCS_REGISTRY_PATH}/base/sph-exa_base-cuda11"
#}}}

#{{{ sph:build:cuda11:
sph:build:cuda11:
  needs: ['sph:base:cuda11']
  extends: .container-builder
  stage: SPHbuild
  before_script:
    - echo "PERSIST_IMAGE_NAME=$PERSIST_IMAGE_NAME"
  variables:
    JG: 'YES'
    DOCKERFILE: 'ci/cuda11/Dockerfile_2'
    PERSIST_IMAGE_NAME: "${BUILD_CUDA11}"
    DOCKER_BUILD_ARGS: '["BASE_IMAGE=$BASE_IMAGE"]'
#}}}
